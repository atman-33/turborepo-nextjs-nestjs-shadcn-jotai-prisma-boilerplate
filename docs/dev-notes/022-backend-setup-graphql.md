# Graphql ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

## ã‚¹ãƒ†ãƒƒãƒ—

### 1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

- graphql etc  

```bash
npm -w apps/api install @nestjs/graphql @nestjs/apollo graphql apollo-server-express
```

- class validator etc  

```bash
npm -w apps/api install class-validator class-transformer
```

> ä»¥é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã€ç¾æ™‚ç‚¹ã§æ©Ÿèƒ½ãŒä¸è¦ã§ã‚ã‚Œã°å¾Œã‹ã‚‰éƒ½åº¦è¿½åŠ ã—ã¦ã‚‚ã‚ˆã„ã€‚

- bcrypt  

```bash
npm -w apps/api install bcrypt
```

- passport etc  

```bash
npm -w apps/api install @nestjs/passport passport passport-local @nestjs/jwt passport-jwt
npm -w apps/api install -D @types/passport-local @types/passport-jwt
```

- cookie-parser  

```bash
npm -w apps/api install cookie-parser
npm -w apps/api install -D @types/cookie-parser
```

- ä¸Šè¨˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¸€æ‹¬å®Ÿè¡Œç”¨  

```bash
npm -w apps/api install @nestjs/graphql @nestjs/apollo graphql apollo-server-express
npm -w apps/api install class-validator class-transformer
npm -w apps/api install bcrypt
npm -w apps/api install @nestjs/passport passport passport-local @nestjs/jwt passport-jwt
npm -w apps/api install -D @types/passport-local @types/passport-jwt
npm -w apps/api install cookie-parser
npm -w apps/api install -D @types/cookie-parser
```

### 2. main.ts ã‚’ä¿®æ­£

`apps/api/src/main.ts`

```ts
import { Logger, ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import * as cookieParser from 'cookie-parser';
import { AppModule } from './app.module';
import { apiEnv } from './config';

async function bootstrap() {
  console.log(`api process.cwd: ${process.cwd()}`);

  const app = await NestFactory.create(AppModule);
  const globalPrefix = 'api';
  app.setGlobalPrefix(globalPrefix);

  app.use(cookieParser());
  app.useGlobalPipes(new ValidationPipe());

  const port = apiEnv.API_PORT || 3000;
  app.enableCors({
    origin: [
      apiEnv.WEB_ORIGIN || 'http://localhost:4200',
      `http://localhost:${port}`,
    ],
    credentials: true,
  });

  await app.listen(port);
  Logger.log(
    `ğŸš€ Application playground is running on: http://localhost:${port}/api/graphql`,
  );
}

bootstrap();
```

> äºˆã‚ã€ env ã® API_PORT, WEB_ORIGIN ã‚’è¨­å®šã—ã¦ãŠãã€‚

### 3. app.module.ts ã‚’ä¿®æ­£

`apps/api/src/app.module.ts`

```ts
import { ApolloDriver, ApolloDriverConfig } from '@nestjs/apollo';
import { Module } from '@nestjs/common';
import { GraphQLModule } from '@nestjs/graphql';
import { ServeStaticModule } from '@nestjs/serve-static';
import { join } from 'path';
import { AppController } from './app.controller';
import { AppService } from './app.service';

@Module({
  imports: [
    GraphQLModule.forRoot<ApolloDriverConfig>({
      driver: ApolloDriver,
      path: '/api/graphql',
      autoSchemaFile: join(__dirname, './autogenerated-schema.gql'),
    }),
    ServeStaticModule.forRoot({
      rootPath: join(__dirname, '../..', 'web/out'),
      exclude: ['/api/*', '/api/graphql'],
    }),
    // ---- GraphQL ---- //
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

> ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã« resolver ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ãŸã‚æ³¨æ„ã™ã‚‹ã“ã¨ã€‚
